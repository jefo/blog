---
title: О том как писать пуленепробеваемый код
tags: JavaScript
---

Тема не новая и ничего нового для опытного разработчика в ней не нет. Статья будет полезна junior разработчикам, которые хотят писать более качественный код. 
В ней я покажу несколько типичных ошибок и примеров их решения. Тему юнит-тестирования в этот раз обойдем стороной, цель в первую очередь получить результат здесь и сейчас, который уже сегодня можно будет применять на практике.

### Немного паранойи не помешает
Anything that can go wrong will go wrong гласит закон Мерфи. И он замечательно работает в контексте разработки, гораздо чаще чем в жизни. 
При написании каждой строчки кода нужно задаваться вопросом "в каком случае выполнение может привести к ошибке?". К ошибке могут привести неправильные данные или плохо продуманный алгоритм выполнения. 
Пока что остановимся на первом типе, так как эти ошибки в JavaScript встречаются чаще, им подвержены даже самые простые скрипты и их действительно просто избежать, если следовать предложенным рекомендациям. 

Несколько примеров.

1. Самая распространенная ошибка - попытка обратиться к несуществующей переменной. В случае возникновения браузер мы увидим 
> Uncaught TypeError: Cannot set property ‘foo’ of undefined

Как избежать?

**Всегда проверяйте входные данные**

Допустим есть объект, который нам вернул сервер в ответ на `GET /user/1`

```javascript
{
  user: { id: 1, firstName: 'Pavel' lastName: 'Durov', position: 'CEO' },
  ... // тут могут быть еще поля, не важно
}
```

И нам нужно вывести эту информацию в хедере в виде `Pavel Durov, CEO`. Пишем функцию, которая получит такую строку из ответа:

```javascript
function getUserNameWithPosFromResponse(response) {
  return response.user.firstName + ' ' + response.user.lastName + ', ' +  response.user.position;
}
```

В контексте темы статьи, какие ошибки допущены в коде?

1. Программист считает, что в `response` является объектом. Но на практике, мы не знаем кто и как будет использовать эту функцию. Всегда может возникнуть ситуация когда другому программисту понадобится "что-то быстро вот тут поправить как было там". Он не станет заглядывать в реализацию, а прочитав название функции передаст в нее свои данные, уже из другого источника, которые в некоторых случаях будет отдавать объект, а в других undefined. В этом случае забота о проверке данных лежит на том, кто реализовал функцию изначально, иначе другие разработчики будут вынуждены делать эти проверки по месту использования, что приведет к куче одинаковых проверок в разных местах. 

Как можно улучшить код?
Нужно добавить проверку, что объект не null и не undefined.

```javascript
function getUserNameWithPosFromResponse(response) {
  if(!response) { // если response null или undefined, выражение примет значение true, за счет чего условие выполнится 
    return; // "вернуть немедленно" - этот прием позволяет избежать вложенности и код немного приятнее
  }
  return response.user.firstName + ' ' + response.user.lastName + ', ' +  response.user.position;
}
```

2. Программист полагается на то, что `response.user` является объектом. Ситуация аналогична первому пункту и решается добавлением еще одной проверки. 

```javascript
function getUserNameWithPosFromResponse(response) {
  if(!response || !reponse.user) {  // обратите внимание на порядок, сначала проверяем response, иначе код может упасть во время самой проверки >.<
    return; //
  }
  return response.user.firstName + ' ' + response.user.lastName + ', ' +  response.user.position;
}
```

> tip: использование lodash решает проблему красивее, см https://lodash.com/docs/4.17.4#get